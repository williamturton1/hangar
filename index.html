<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangar - Picture Hanging Calculator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 24 40' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='24' height='40' fill='%23000'/%3E%3Crect x='3' y='0' width='4' height='20' fill='white'/%3E%3Crect x='7' y='2' width='3' height='1' fill='white'/%3E%3Crect x='7' y='5' width='2' height='1' fill='white'/%3E%3Crect x='7' y='8' width='3' height='1' fill='white'/%3E%3Crect x='7' y='11' width='2' height='1' fill='white'/%3E%3Crect x='7' y='14' width='3' height='1' fill='white'/%3E%3Crect x='7' y='17' width='2' height='1' fill='white'/%3E%3Crect x='2' y='0' width='6' height='2' fill='white'/%3E%3Crect x='0' y='18' width='10' height='10' fill='white'/%3E%3Crect x='10' y='22' width='4' height='3' fill='white'/%3E%3Crect x='14' y='22' width='4' height='18' fill='white'/%3E%3Crect x='3' y='28' width='4' height='12' fill='white'/%3E%3C/svg%3E">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #000;
            color: #ccc;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: levelPicture 2s ease-out forwards;
            transform-origin: center top;
        }

        @keyframes levelPicture {
            0% {
                transform: rotate(-3deg);
                opacity: 0.7;
            }
            15% {
                transform: rotate(2.5deg);
                opacity: 0.85;
            }
            30% {
                transform: rotate(-2deg);
                opacity: 0.9;
            }
            45% {
                transform: rotate(1.5deg);
                opacity: 0.95;
            }
            60% {
                transform: rotate(-1deg);
            }
            75% {
                transform: rotate(0.5deg);
            }
            85% {
                transform: rotate(-0.25deg);
            }
            100% {
                transform: rotate(0deg);
                opacity: 1;
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 4px;
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }

        .logo-h {
            position: relative;
            width: 24px;
            height: 40px;
            margin-bottom: -3px;
        }

        .logo-text {
            color: #fff;
            font-size: 1.2rem;
            font-weight: 400;
            line-height: 1;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.8rem;
        }

        .card {
            background: #111;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #333;
        }

        .card h2 {
            color: #fff;
            margin-bottom: 16px;
            font-size: 0.9rem;
            font-weight: 400;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
        }

        label {
            display: block;
            color: #888;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #333;
            font-size: 1rem;
            background: #000;
            color: #fff;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: #fff;
        }

        input::placeholder {
            color: #444;
        }

        .unit-toggle {
            display: flex;
            background: #000;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid #333;
        }

        .unit-toggle button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            color: #666;
            font-family: inherit;
        }

        .unit-toggle button.active {
            background: #fff;
            color: #000;
        }

        .spacing-options {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #333;
        }

        .spacing-options label {
            display: block;
            margin-bottom: 8px;
        }

        .spacing-toggle {
            display: flex;
            background: #000;
            padding: 0;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .spacing-toggle button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            color: #666;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .spacing-toggle button.active {
            background: #fff;
            color: #000;
        }

        .custom-spacing-input {
            display: none;
        }

        .custom-spacing-input.visible {
            display: block;
        }

        .btn {
            padding: 12px 20px;
            background: #fff;
            color: #000;
            border: none;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            font-family: inherit;
        }

        .btn:hover {
            background: #ccc;
        }

        .btn-full {
            width: 100%;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .hidden {
            display: none !important;
        }

        .piece-card {
            background: #0a0a0a;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .piece-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .piece-card h3 {
            color: #fff;
            margin: 0;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .btn-remove {
            background: transparent;
            color: #666;
            border: 1px solid #333;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-remove:hover {
            background: #333;
            color: #fff;
        }

        .btn-add {
            background: transparent;
            border: 1px dashed #333;
            color: #666;
            padding: 16px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .btn-add:hover {
            border-color: #fff;
            color: #fff;
        }

        .result-value {
            color: #0f0;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .result-item {
            background: #0a0a0a;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 2px solid #fff;
        }

        .result-item h3 {
            color: #666;
            margin-bottom: 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-item .note {
            color: #444;
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .help-text {
            font-size: 0.75rem;
            color: #444;
            margin-top: 4px;
        }

        .wall-diagram {
            position: relative;
            background: #fff;
            border: 1px solid #333;
            margin: 20px auto;
            width: 100%;
            max-width: 600px;
            height: 450px;
            overflow: hidden;
        }

        .floor-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #000;
        }

        .frame-8bit {
            position: absolute;
            image-rendering: pixelated;
            background: #fff;
            border: 3px solid #000;
        }

        .nail {
            position: absolute;
            width: 24px;
            height: 24px;
            transform: translate(-50%, -50%);
            z-index: 20;
            font-size: 20px;
            font-weight: bold;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nail::before {
            content: 'X';
        }

        .frame-number {
            position: absolute;
            color: #000;
            font-size: 1.2rem;
            font-weight: 700;
            z-index: 10;
        }

        .leader-line {
            position: absolute;
            border-top: 1px solid #000;
            z-index: 25;
        }

        .center-height-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: repeating-linear-gradient(
                to right,
                #999 0px,
                #999 3px,
                transparent 3px,
                transparent 8px
            );
            z-index: 2;
        }

        .center-height-label {
            position: absolute;
            right: 6px;
            background: #fff;
            color: #666;
            padding: 1px 4px;
            font-size: 0.6rem;
            z-index: 3;
        }

        .hardware-height-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: repeating-linear-gradient(
                to right,
                #666 0px,
                #666 6px,
                transparent 6px,
                transparent 12px
            );
            z-index: 2;
        }

        .spacing-line {
            position: absolute;
            height: 1px;
            background: #000;
        }

        .spacing-label {
            position: absolute;
            background: #000;
            color: #0f0;
            padding: 2px 4px;
            font-size: 0.65rem;
            font-weight: 600;
            white-space: nowrap;
            transform: translateX(-50%);
        }

        .diagram-label {
            position: absolute;
            background: #000;
            color: #0f0;
            padding: 2px 4px;
            font-size: 0.65rem;
            font-weight: 700;
            white-space: nowrap;
            z-index: 30;
        }

        .diagram-measurement {
            position: absolute;
            background: #000;
            z-index: 15;
        }

        .floor-label {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: #000;
            color: #fff;
            padding: 2px 6px;
            font-size: 0.7rem;
        }

        .center-line {
            position: absolute;
            top: 30px;
            bottom: 4px;
            width: 1px;
            background: repeating-linear-gradient(
                to bottom,
                #000 0px,
                #000 4px,
                transparent 4px,
                transparent 8px
            );
            z-index: 5;
            left: 50%;
            transform: translateX(-50%);
        }

        .center-label {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 2px 6px;
            font-size: 0.65rem;
            white-space: nowrap;
            z-index: 25;
        }

        .settings-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .optional-tag {
            font-size: 0.7rem;
            color: #444;
            font-weight: normal;
        }

        .credits {
            text-align: center;
            color: #333;
            font-size: 0.6rem;
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 600px) {
            .input-row, .settings-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-h">
                <svg viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Tape measure: tape extending upward -->
                    <rect x="3" y="0" width="4" height="20" fill="white"/>
                    <!-- Tick marks on tape -->
                    <rect x="7" y="2" width="3" height="1" fill="white"/>
                    <rect x="7" y="5" width="2" height="1" fill="white"/>
                    <rect x="7" y="8" width="3" height="1" fill="white"/>
                    <rect x="7" y="11" width="2" height="1" fill="white"/>
                    <rect x="7" y="14" width="3" height="1" fill="white"/>
                    <rect x="7" y="17" width="2" height="1" fill="white"/>
                    <!-- Hook at top -->
                    <rect x="2" y="0" width="6" height="2" fill="white"/>
                    <!-- Tape measure body (forms bottom of h) -->
                    <rect x="0" y="18" width="10" height="10" fill="white"/>
                    <!-- h arch connection -->
                    <rect x="10" y="22" width="4" height="3" fill="white"/>
                    <!-- h right leg -->
                    <rect x="14" y="22" width="4" height="18" fill="white"/>
                    <!-- h left leg extension -->
                    <rect x="3" y="28" width="4" height="12" fill="white"/>
                </svg>
            </div>
            <span class="logo-text">angar</span>
        </div>
        <p class="subtitle">picture hanging calculator</p>

        <div class="card">
            <h2>Settings</h2>

            <div class="unit-toggle">
                <button class="active" id="unitInches" onclick="setUnit('inches')">Inches</button>
                <button id="unitCm" onclick="setUnit('cm')">Centimeters</button>
            </div>

            <div class="settings-row">
                <div class="input-field">
                    <label>Center Height from Floor</label>
                    <input type="text" id="centerHeight" value="60" placeholder="60">
                    <p class="help-text">Standard gallery height is 60"</p>
                </div>
                <div class="input-field">
                    <label>Wall Length <span class="optional-tag">(optional)</span></label>
                    <input type="text" id="wallWidth" placeholder="e.g., 120 or 10 ft">
                </div>
                <div class="input-field">
                    <label>Wall Height <span class="optional-tag">(optional)</span></label>
                    <input type="text" id="wallHeight" placeholder="e.g., 96 or 8 ft">
                </div>
            </div>

            <div class="spacing-options" id="spacingOptions">
                <label>Spacing Mode (for multiple pieces)</label>
                <div class="spacing-toggle">
                    <button class="active" id="spacingEven" onclick="setSpacingMode('even')">Evenly Spaced</button>
                    <button id="spacingCustom" onclick="setSpacingMode('custom')">Custom Spacing</button>
                </div>
                <div class="custom-spacing-input" id="customSpacingInput">
                    <div class="input-field">
                        <label>Space Between Pieces</label>
                        <input type="text" id="customSpacing" placeholder="e.g., 6 or 6 1/2">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Pictures</h2>
            <div id="piecesContainer"></div>
            <button class="btn-add" onclick="addPiece()">+ Add Another Piece</button>
            <button class="btn btn-full" onclick="calculate()">Calculate Nail Positions</button>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <div class="card">
                <h2>Nail Placement Guide</h2>
                <div id="resultsContainer"></div>
            </div>

            <div class="card">
                <h2>Wall Diagram</h2>
                <div class="wall-diagram" id="wallDiagram">
                    <div class="floor-line"></div>
                    <div class="floor-label">Floor</div>
                </div>
            </div>

            <button class="btn btn-secondary btn-full" onclick="startOver()">Start Over</button>
        </div>

        <div class="credits">
            Created by Matt Donahue, William Turton, Ryan Scheuer, and Johnny Hamcheck
        </div>
    </div>

    <script>
        let currentUnit = 'inches';
        let pieceCount = 1;
        let pieces = [];
        let spacingMode = 'even'; // 'even' or 'custom'
        const CM_PER_INCH = 2.54;

        function setSpacingMode(mode) {
            spacingMode = mode;
            document.getElementById('spacingEven').classList.toggle('active', mode === 'even');
            document.getElementById('spacingCustom').classList.toggle('active', mode === 'custom');
            document.getElementById('customSpacingInput').classList.toggle('visible', mode === 'custom');
        }

        function parseMixedNumber(str) {
            if (!str || str.trim() === '') return NaN;
            str = str.trim().toLowerCase();

            if (str.includes('ft') || str.includes("'")) {
                const ftMatch = str.match(/^([\d.]+)\s*(?:ft|')?\s*(?:([\d.]+)\s*(?:in|")?)?\s*$/);
                if (ftMatch) {
                    const feet = parseFloat(ftMatch[1]) || 0;
                    const inches = parseFloat(ftMatch[2]) || 0;
                    return feet * 12 + inches;
                }
            }

            const mixedMatch = str.match(/^(\d+)\s+(\d+)\/(\d+)$/);
            if (mixedMatch) {
                const whole = parseInt(mixedMatch[1]);
                const num = parseInt(mixedMatch[2]);
                const den = parseInt(mixedMatch[3]);
                return whole + (num / den);
            }

            const fracMatch = str.match(/^(\d+)\/(\d+)$/);
            if (fracMatch) {
                return parseInt(fracMatch[1]) / parseInt(fracMatch[2]);
            }

            return parseFloat(str);
        }

        function toMixedNumber(decimal) {
            if (isNaN(decimal)) return '--';

            const isNegative = decimal < 0;
            decimal = Math.abs(decimal);

            const whole = Math.floor(decimal);
            let remainder = decimal - whole;

            const sixteenths = Math.round(remainder * 16);

            if (sixteenths === 0) {
                return (isNegative ? '-' : '') + whole + '"';
            }
            if (sixteenths === 16) {
                return (isNegative ? '-' : '') + (whole + 1) + '"';
            }

            let num = sixteenths;
            let den = 16;

            while (num % 2 === 0 && den % 2 === 0) {
                num /= 2;
                den /= 2;
            }

            if (whole === 0) {
                return (isNegative ? '-' : '') + num + '/' + den + '"';
            }
            return (isNegative ? '-' : '') + whole + ' ' + num + '/' + den + '"';
        }

        function formatResult(inches) {
            if (currentUnit === 'cm') {
                return (inches * CM_PER_INCH).toFixed(1) + ' cm';
            }
            return toMixedNumber(inches);
        }

        function toInches(value) {
            return currentUnit === 'cm' ? value / CM_PER_INCH : value;
        }

        function setUnit(unit) {
            currentUnit = unit;
            document.getElementById('unitInches').classList.toggle('active', unit === 'inches');
            document.getElementById('unitCm').classList.toggle('active', unit === 'cm');

            const inchPlaceholder = unit === 'inches' ? 'e.g., 24 or 24 1/2' : 'e.g., 61';
            document.querySelectorAll('.dimension-input').forEach(input => {
                input.placeholder = inchPlaceholder;
            });
        }

        let pieceIdCounter = 0;

        function addPiece() {
            const container = document.getElementById('piecesContainer');
            const pieceId = pieceIdCounter++;
            const pieceCount = container.children.length + 1;

            const pieceDiv = document.createElement('div');
            pieceDiv.className = 'piece-card';
            pieceDiv.id = `piece-${pieceId}`;
            pieceDiv.innerHTML = `
                <div class="piece-header">
                    <h3>Piece ${pieceCount}</h3>
                    <button class="btn-remove" onclick="removePiece(${pieceId})">Remove</button>
                </div>
                <div class="input-row">
                    <div class="input-field">
                        <label>Width</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="width" placeholder="e.g., 24 or 24 1/2">
                    </div>
                    <div class="input-field">
                        <label>Height</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="height" placeholder="e.g., 36 or 36 1/4">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 12px;">
                    <div class="input-field">
                        <label>Hardware Span</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="span" placeholder="e.g., 16">
                        <p class="help-text">Distance between hanging points</p>
                    </div>
                    <div class="input-field">
                        <label>Hardware from Top</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="fromTop" placeholder="e.g., 4">
                        <p class="help-text">Distance from top to hardware</p>
                    </div>
                </div>
            `;
            container.appendChild(pieceDiv);
            updatePieceNumbers();
        }

        function removePiece(pieceId) {
            const pieceDiv = document.getElementById(`piece-${pieceId}`);
            if (pieceDiv) {
                pieceDiv.remove();
                updatePieceNumbers();
                if (!document.getElementById('results').classList.contains('hidden')) {
                    calculate();
                }
            }
        }

        function updatePieceNumbers() {
            const container = document.getElementById('piecesContainer');
            const pieces = container.querySelectorAll('.piece-card');
            pieces.forEach((piece, index) => {
                const h3 = piece.querySelector('h3');
                if (h3) h3.textContent = `Piece ${index + 1}`;
            });
        }

        function calculate() {
            const container = document.getElementById('piecesContainer');
            const pieceCards = container.querySelectorAll('.piece-card');

            if (pieceCards.length === 0) {
                alert('Please add at least one piece');
                return;
            }

            const centerHeight = toInches(parseMixedNumber(document.getElementById('centerHeight').value)) || 60;
            const wallWidth = parseMixedNumber(document.getElementById('wallWidth').value);
            const wallHeight = parseMixedNumber(document.getElementById('wallHeight').value);

            pieces = [];

            let hasError = false;
            pieceCards.forEach((card, i) => {
                const pieceId = card.id.replace('piece-', '');
                const width = parseMixedNumber(card.querySelector(`[data-field="width"]`).value);
                const height = parseMixedNumber(card.querySelector(`[data-field="height"]`).value);
                const span = parseMixedNumber(card.querySelector(`[data-field="span"]`).value);
                const fromTop = parseMixedNumber(card.querySelector(`[data-field="fromTop"]`).value);

                if (isNaN(width) || isNaN(height) || isNaN(span) || isNaN(fromTop)) {
                    alert(`Please fill in all fields for Piece ${i + 1}`);
                    hasError = true;
                    return;
                }

                const widthIn = toInches(width);
                const heightIn = toInches(height);
                const spanIn = toInches(span);
                const fromTopIn = toInches(fromTop);

                const pictureTop = centerHeight + (heightIn / 2);
                const nailHeight = pictureTop - fromTopIn;

                pieces.push({
                    index: i + 1,
                    width: widthIn,
                    height: heightIn,
                    span: spanIn,
                    fromTop: fromTopIn,
                    nailHeight: nailHeight,
                    centerHeight: centerHeight
                });
            });

            if (hasError) return;

            renderResults();
            drawDiagram(wallWidth ? toInches(wallWidth) : null, wallHeight ? toInches(wallHeight) : null);

            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            pieces.forEach((piece, i) => {
                const html = `
                    <div class="piece-card">
                        <h3>Piece ${piece.index}</h3>
                        <div class="result-item">
                            <h3>Nail Height from Floor</h3>
                            <div class="result-value">${formatResult(piece.nailHeight)}</div>
                            <div class="note">Measure up from the floor</div>
                        </div>
                        <div class="input-row">
                            <div class="result-item" style="flex:1">
                                <h3>Distance Between Nails</h3>
                                <div class="result-value">${formatResult(piece.span)}</div>
                            </div>
                            <div class="result-item" style="flex:1">
                                <h3>Each Nail from Center</h3>
                                <div class="result-value">${formatResult(piece.span / 2)}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function drawDiagram(wallWidthIn, wallHeightIn) {
            const diagram = document.getElementById('wallDiagram');

            diagram.innerHTML = '<div class="floor-line"></div><div class="floor-label">Floor</div><div class="center-line"></div><div class="center-label">Center</div>';

            // Get center height for reference lines
            const centerHeight = pieces.length > 0 ? pieces[0].centerHeight : 60;

            const totalPiecesWidth = pieces.reduce((sum, p) => sum + p.width, 0);

            const diagramWidth = diagram.offsetWidth || 600;
            const diagramHeight = 450;

            const effectiveWallHeight = wallHeightIn || 96;

            // Calculate spacing based on mode
            let spacing = 0;
            let effectiveWallWidth;

            if (pieces.length > 1) {
                if (spacingMode === 'custom') {
                    // Custom spacing mode
                    const customSpacingValue = parseMixedNumber(document.getElementById('customSpacing').value);
                    spacing = isNaN(customSpacingValue) ? 12 : toInches(customSpacingValue);
                    effectiveWallWidth = wallWidthIn || Math.max(totalPiecesWidth + spacing * (pieces.length - 1) + 40, 80);
                } else {
                    // Even spacing mode - distribute pieces evenly across wall
                    effectiveWallWidth = wallWidthIn || Math.max(totalPiecesWidth + 60, 120);
                    // Calculate spacing to evenly distribute: wall width minus all pieces, divided by (number of gaps + 2 edges)
                    const availableSpace = effectiveWallWidth - totalPiecesWidth;
                    spacing = availableSpace / (pieces.length + 1);
                }
            } else {
                effectiveWallWidth = wallWidthIn || Math.max(totalPiecesWidth + 40, 80);
            }

            const totalWidth = totalPiecesWidth + spacing * (pieces.length - 1);

            const scaleY = (diagramHeight - 20) / effectiveWallHeight;
            const scaleX = (diagramWidth - 40) / effectiveWallWidth;
            const scale = Math.min(scaleX, scaleY);

            // Calculate starting X position based on spacing mode
            let currentX;
            if (pieces.length > 1 && spacingMode === 'even') {
                // For even spacing, start after the first edge gap
                currentX = (diagramWidth - (effectiveWallWidth * scale)) / 2 + (spacing * scale);
            } else {
                currentX = (diagramWidth - (totalWidth * scale)) / 2;
            }

            // Add center height reference line (dotted)
            const centerHeightY = diagramHeight - (centerHeight * scale);
            const centerHeightLine = document.createElement('div');
            centerHeightLine.className = 'center-height-line';
            centerHeightLine.style.top = centerHeightY + 'px';
            diagram.appendChild(centerHeightLine);

            const centerHeightLabel = document.createElement('div');
            centerHeightLabel.className = 'center-height-label';
            centerHeightLabel.textContent = formatResult(centerHeight) + ' center';
            centerHeightLabel.style.top = (centerHeightY - 8) + 'px';
            diagram.appendChild(centerHeightLabel);

            // Track label positions to avoid overlap
            let usedLabelPositions = [];

            pieces.forEach((piece, i) => {
                const picWidth = piece.width * scale;
                const picHeight = piece.height * scale;
                const picBottom = (piece.centerHeight - piece.height / 2) * scale;

                // Add hardware height reference line (dashed) for each piece
                const hardwareHeightLine = document.createElement('div');
                hardwareHeightLine.className = 'hardware-height-line';
                hardwareHeightLine.style.top = (diagramHeight - piece.nailHeight * scale) + 'px';
                diagram.appendChild(hardwareHeightLine);

                const frame = document.createElement('div');
                frame.className = 'frame-8bit';
                frame.style.width = picWidth + 'px';
                frame.style.height = picHeight + 'px';
                frame.style.left = currentX + 'px';
                frame.style.bottom = picBottom + 'px';
                diagram.appendChild(frame);

                // Add frame number
                const frameNumber = document.createElement('div');
                frameNumber.className = 'frame-number';
                frameNumber.textContent = piece.index;
                frameNumber.style.left = (currentX + picWidth / 2) + 'px';
                frameNumber.style.bottom = (picBottom + picHeight / 2) + 'px';
                frameNumber.style.transform = 'translate(-50%, 50%)';
                diagram.appendChild(frameNumber);

                const nailY = diagramHeight - (piece.nailHeight * scale);
                const centerX = currentX + picWidth / 2;
                const nailOffset = (piece.span / 2) * scale;

                const nail1 = document.createElement('div');
                nail1.className = 'nail';
                nail1.style.left = (centerX - nailOffset) + 'px';
                nail1.style.top = nailY + 'px';
                diagram.appendChild(nail1);

                const nail2 = document.createElement('div');
                nail2.className = 'nail';
                nail2.style.left = (centerX + nailOffset) + 'px';
                nail2.style.top = nailY + 'px';
                diagram.appendChild(nail2);

                // Height label - position to the left, stagger if needed
                const heightLabel = document.createElement('div');
                heightLabel.className = 'diagram-label';
                heightLabel.textContent = formatResult(piece.nailHeight);

                let labelLeft = 5;
                let labelTop = nailY - 8;

                // Check for overlap with existing labels
                for (let pos of usedLabelPositions) {
                    if (Math.abs(pos.top - labelTop) < 20 && Math.abs(pos.left - labelLeft) < 60) {
                        labelTop = pos.top + 18;
                    }
                }
                usedLabelPositions.push({left: labelLeft, top: labelTop});

                heightLabel.style.left = labelLeft + 'px';
                heightLabel.style.top = labelTop + 'px';
                diagram.appendChild(heightLabel);

                // Leader line from height label to nail
                const leaderLine = document.createElement('div');
                leaderLine.className = 'leader-line';
                const leaderStartX = 50;
                const leaderEndX = centerX - nailOffset - 12;
                leaderLine.style.left = leaderStartX + 'px';
                leaderLine.style.top = nailY + 'px';
                leaderLine.style.width = (leaderEndX - leaderStartX) + 'px';
                diagram.appendChild(leaderLine);

                // Span label - position above the frame
                const spanLabel = document.createElement('div');
                spanLabel.className = 'diagram-label';
                spanLabel.textContent = formatResult(piece.span);
                spanLabel.style.left = centerX + 'px';
                spanLabel.style.bottom = (picBottom + picHeight + 15) + 'px';
                spanLabel.style.transform = 'translateX(-50%)';
                diagram.appendChild(spanLabel);

                // Span line
                const spanLine = document.createElement('div');
                spanLine.className = 'diagram-measurement';
                spanLine.style.height = '1px';
                spanLine.style.width = (nailOffset * 2) + 'px';
                spanLine.style.left = (centerX - nailOffset) + 'px';
                spanLine.style.bottom = (picBottom + picHeight + 10) + 'px';
                diagram.appendChild(spanLine);

                // Height line
                const heightLine = document.createElement('div');
                heightLine.className = 'diagram-measurement';
                heightLine.style.width = '1px';
                heightLine.style.height = (diagramHeight - nailY - 2) + 'px';
                heightLine.style.left = (currentX - 10) + 'px';
                heightLine.style.bottom = '2px';
                diagram.appendChild(heightLine);

                piece.rightEdgeX = currentX + picWidth;
                piece.leftEdgeX = currentX;
                piece.picBottom = picBottom;
                piece.picHeight = picHeight;

                currentX += picWidth + spacing * scale;
            });

            // Draw spacing indicators between paintings
            if (pieces.length > 1) {
                for (let i = 0; i < pieces.length - 1; i++) {
                    const leftPiece = pieces[i];
                    const rightPiece = pieces[i + 1];

                    const gapStart = leftPiece.rightEdgeX + 3;
                    const gapEnd = rightPiece.leftEdgeX - 3;
                    const gapWidth = gapEnd - gapStart;

                    const avgBottom = (leftPiece.picBottom + rightPiece.picBottom) / 2;
                    const avgHeight = (leftPiece.picHeight + rightPiece.picHeight) / 2;
                    const lineY = diagramHeight - avgBottom - avgHeight / 2;

                    const spacingLine = document.createElement('div');
                    spacingLine.className = 'spacing-line';
                    spacingLine.style.width = gapWidth + 'px';
                    spacingLine.style.left = gapStart + 'px';
                    spacingLine.style.top = lineY + 'px';
                    diagram.appendChild(spacingLine);

                    const spacingLabel = document.createElement('div');
                    spacingLabel.className = 'spacing-label';
                    spacingLabel.textContent = formatResult(spacing);
                    spacingLabel.style.left = (gapStart + gapWidth / 2) + 'px';
                    spacingLabel.style.top = (lineY - 18) + 'px';
                    diagram.appendChild(spacingLabel);
                }
            }
        }

        function startOver() {
            pieces = [];
            pieceIdCounter = 0;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('piecesContainer').innerHTML = '';
            addPiece();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', function() {
            addPiece();
        });
    </script>
</body>
</html>
