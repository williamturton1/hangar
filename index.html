<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangar - Picture Hanging Calculator</title>
    <link rel="icon" type="image/png" href="HangarLogo.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #000;
            color: #ccc;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: levelPicture 2s ease-out forwards;
            transform-origin: center top;
        }

        @keyframes levelPicture {
            0% {
                transform: rotate(-3deg);
                opacity: 0.7;
            }
            15% {
                transform: rotate(2.5deg);
                opacity: 0.85;
            }
            30% {
                transform: rotate(-2deg);
                opacity: 0.9;
            }
            45% {
                transform: rotate(1.5deg);
                opacity: 0.95;
            }
            60% {
                transform: rotate(-1deg);
            }
            75% {
                transform: rotate(0.5deg);
            }
            85% {
                transform: rotate(-0.25deg);
            }
            100% {
                transform: rotate(0deg);
                opacity: 1;
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-img {
            max-width: 380px;
            width: 100%;
            height: auto;
            filter: invert(1);
        }

        .card {
            background: #111;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #333;
        }

        .card h2 {
            color: #fff;
            margin-bottom: 16px;
            font-size: 0.9rem;
            font-weight: 400;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
        }

        label {
            display: block;
            color: #888;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #333;
            font-size: 1rem;
            background: #000;
            color: #fff;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: #fff;
        }

        input::placeholder {
            color: #444;
        }

        .unit-toggle {
            display: flex;
            background: #000;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid #333;
        }

        .unit-toggle button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            color: #666;
            font-family: inherit;
        }

        .unit-toggle button.active {
            background: #fff;
            color: #000;
        }

        .spacing-options {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #333;
        }

        .spacing-options label {
            display: block;
            margin-bottom: 8px;
        }

        .spacing-toggle {
            display: flex;
            background: #000;
            padding: 0;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .spacing-toggle button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            color: #666;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .spacing-toggle button.active {
            background: #fff;
            color: #000;
        }

        .custom-spacing-input {
            display: none;
        }

        .custom-spacing-input.visible {
            display: block;
        }

        .btn {
            padding: 12px 20px;
            background: #fff;
            color: #000;
            border: none;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            font-family: inherit;
        }

        .btn:hover {
            background: #ccc;
        }

        .btn-full {
            width: 100%;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .hidden {
            display: none !important;
        }

        .piece-card {
            background: #0a0a0a;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .piece-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .piece-card h3 {
            color: #fff;
            margin: 0;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .btn-remove {
            background: transparent;
            color: #666;
            border: 1px solid #333;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-remove:hover {
            background: #333;
            color: #fff;
        }

        .btn-add {
            background: transparent;
            border: 1px dashed #333;
            color: #666;
            padding: 16px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .btn-add:hover {
            border-color: #fff;
            color: #fff;
        }

        .result-value {
            color: #0f0;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .result-item {
            background: #0a0a0a;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 2px solid #fff;
        }

        .result-item h3 {
            color: #666;
            margin-bottom: 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-item .note {
            color: #444;
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .help-text {
            font-size: 0.75rem;
            color: #444;
            margin-top: 4px;
        }

        .canvas-container {
            position: relative;
            background: transparent;
            margin: 20px auto;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
        }

        #diagramCanvas {
            display: block;
            border: 2px solid #000;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
        }

        .canvas-tooltip {
            position: absolute;
            background: #000;
            color: #0f0;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: bold;
            pointer-events: none;
            display: none;
            white-space: nowrap;
            z-index: 100;
        }

        .diagram-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            background: #222;
            border: 1px solid #333;
            margin-left: auto;
        }

        .view-toggle button {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.75rem;
            color: #666;
            font-family: inherit;
        }

        .view-toggle button.active {
            background: #444;
            color: #fff;
        }

        body.light-mode .view-toggle {
            background: #eee;
            border-color: #ccc;
        }

        body.light-mode .view-toggle button.active {
            background: #000;
            color: #fff;
        }

        .btn-save {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-save:hover {
            background: #444;
        }

        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }

        .debug-toggle {
            width: 24px;
            height: 24px;
            background: #222;
            border: 1px solid #333;
            color: #444;
            font-size: 10px;
            cursor: pointer;
            font-family: inherit;
        }

        .debug-toggle:hover {
            color: #888;
            border-color: #555;
        }

        .debug-menu {
            display: none;
            position: absolute;
            bottom: 28px;
            right: 0;
            background: #111;
            border: 1px solid #333;
            padding: 8px;
            min-width: 120px;
        }

        .debug-menu.open {
            display: block;
        }

        .debug-menu button {
            display: block;
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: #222;
            border: 1px solid #333;
            color: #666;
            font-size: 0.7rem;
            cursor: pointer;
            text-align: left;
            font-family: inherit;
        }

        .debug-menu button:last-child {
            margin-bottom: 0;
        }

        .debug-menu button:hover {
            background: #333;
            color: #fff;
        }

        .settings-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .optional-tag {
            font-size: 0.7rem;
            color: #444;
            font-weight: normal;
        }

        .credits {
            text-align: center;
            color: #333;
            font-size: 0.6rem;
            margin-top: 40px;
            padding: 20px;
        }

        .color-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #333;
            border: 1px solid #555;
            color: #888;
            padding: 6px 12px;
            font-size: 0.7rem;
            cursor: pointer;
            font-family: inherit;
            z-index: 1000;
        }

        .color-toggle:hover {
            background: #444;
            color: #fff;
        }

        /* Light mode */
        body.light-mode {
            background: #fff;
            color: #333;
        }

        body.light-mode .card {
            background: #f5f5f5;
            border-color: #ddd;
        }

        body.light-mode .card h2 {
            color: #000;
            border-bottom-color: #ddd;
        }

        body.light-mode input[type="text"],
        body.light-mode input[type="number"] {
            background: #fff;
            color: #000;
            border-color: #ccc;
        }

        body.light-mode input:focus {
            border-color: #000;
        }

        body.light-mode input::placeholder {
            color: #999;
        }

        body.light-mode .unit-toggle,
        body.light-mode .spacing-toggle {
            background: #fff;
            border-color: #ccc;
        }

        body.light-mode .unit-toggle button,
        body.light-mode .spacing-toggle button {
            color: #666;
        }

        body.light-mode .unit-toggle button.active,
        body.light-mode .spacing-toggle button.active {
            background: #000;
            color: #fff;
        }

        body.light-mode .piece-card {
            background: #eee;
            border-color: #ddd;
        }

        body.light-mode .piece-card h3 {
            color: #000;
        }

        body.light-mode .btn-add {
            border-color: #ccc;
            color: #666;
        }

        body.light-mode .btn-add:hover {
            border-color: #000;
            color: #000;
        }

        body.light-mode .btn {
            background: #000;
            color: #fff;
        }

        body.light-mode .btn:hover {
            background: #333;
        }

        body.light-mode .btn-secondary {
            background: #ccc;
            color: #000;
        }

        body.light-mode .btn-secondary:hover {
            background: #bbb;
        }

        body.light-mode .result-item {
            background: #eee;
            border-left-color: #000;
        }

        body.light-mode .result-item h3 {
            color: #666;
        }

        body.light-mode .result-value {
            color: #060;
        }

        body.light-mode .help-text,
        body.light-mode .subtitle {
            color: #888;
        }

        body.light-mode label {
            color: #555;
        }

        body.light-mode .credits {
            color: #aaa;
        }

        body.light-mode .canvas-container {
            border-color: #000;
        }

        body.light-mode .btn-save {
            background: #ddd;
            color: #000;
        }

        body.light-mode .btn-save:hover {
            background: #ccc;
        }

        body.light-mode .color-toggle {
            background: #eee;
            border-color: #ccc;
            color: #666;
        }

        body.light-mode .color-toggle:hover {
            background: #ddd;
            color: #000;
        }

        body.light-mode .logo-img {
            filter: none;
        }

        body.light-mode .btn-remove {
            border-color: #ccc;
            color: #888;
        }

        body.light-mode .btn-remove:hover {
            background: #ddd;
            color: #000;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            .card {
                padding: 16px;
                margin-bottom: 12px;
            }

            .card h2 {
                font-size: 0.8rem;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }

            .input-row, .settings-row {
                flex-direction: column;
                gap: 8px;
            }

            .piece-card {
                padding: 12px;
                margin-bottom: 8px;
            }

            .piece-card h3 {
                font-size: 0.85rem;
            }

            /* Compact results on mobile */
            .result-value {
                font-size: 1.3rem;
            }

            .result-item {
                padding: 10px 12px;
                margin-bottom: 8px;
            }

            .result-item h3 {
                font-size: 0.7rem;
                margin-bottom: 4px;
            }

            .result-item .note {
                font-size: 0.7rem;
                margin-top: 4px;
            }

            /* Make the two-column results stay side by side on mobile */
            .piece-card .input-row {
                flex-direction: row;
                gap: 8px;
            }

            .piece-card .input-row .result-item {
                padding: 8px 10px;
            }

            .piece-card .input-row .result-value {
                font-size: 1.1rem;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .btn-add {
                padding: 12px;
                font-size: 0.9rem;
            }

            .diagram-actions {
                flex-direction: column;
                gap: 8px;
            }

            .view-toggle {
                margin-left: 0;
                width: 100%;
            }

            .view-toggle button {
                flex: 1;
            }

            .btn-save {
                flex: 1;
                text-align: center;
            }

            .logo-img {
                max-width: 260px;
            }

            .logo {
                margin-bottom: 20px;
            }

            .canvas-container {
                margin: 10px auto;
            }

            #diagramCanvas {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="color-toggle" onclick="toggleColorMode()" id="colorToggle">light mode</button>
    <div class="container">
        <div class="logo">
            <img src="HangarLogo.png" alt="hangar" class="logo-img">
        </div>

        <div class="card">
            <h2>Settings</h2>

            <div class="unit-toggle">
                <button class="active" id="unitInches" onclick="setUnit('inches')">Inches</button>
                <button id="unitCm" onclick="setUnit('cm')">Centimeters</button>
            </div>

            <div class="settings-row">
                <div class="input-field">
                    <label>Center Height from Floor</label>
                    <input type="text" id="centerHeight" value="60" placeholder="60">
                    <p class="help-text">Standard gallery height is 60"</p>
                </div>
                <div class="input-field">
                    <label>Wall Length <span class="optional-tag">(optional)</span></label>
                    <input type="text" id="wallWidth" placeholder="e.g., 120 or 10 ft">
                </div>
                <div class="input-field">
                    <label>Wall Height <span class="optional-tag">(optional)</span></label>
                    <input type="text" id="wallHeight" placeholder="e.g., 96 or 8 ft">
                </div>
            </div>

            <div class="spacing-options" id="spacingOptions">
                <label>Spacing Mode (for multiple pieces)</label>
                <div class="spacing-toggle">
                    <button class="active" id="spacingEven" onclick="setSpacingMode('even')">Evenly Spaced</button>
                    <button id="spacingCustom" onclick="setSpacingMode('custom')">Custom Spacing</button>
                </div>
                <div class="custom-spacing-input" id="customSpacingInput">
                    <div class="input-field">
                        <label>Space Between Pieces</label>
                        <input type="text" id="customSpacing" placeholder="e.g., 6 or 6 1/2">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Pictures</h2>
            <div id="piecesContainer"></div>
            <button class="btn-add" onclick="addPiece()">+ Add Another Piece</button>
            <button class="btn btn-full" onclick="calculate()">Calculate Nail Positions</button>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <div class="card">
                <h2>Nail Placement Guide</h2>
                <div id="resultsContainer"></div>
            </div>

            <div class="card">
                <h2>Wall Diagram</h2>
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="diagramCanvas"></canvas>
                    <div class="canvas-tooltip" id="canvasTooltip"></div>
                </div>
                <div class="diagram-actions">
                    <button class="btn-save" onclick="saveDiagram()">Save Diagram</button>
                    <button class="btn-save" onclick="copyDiagram()">Copy to Clipboard</button>
                    <div class="view-toggle">
                        <button class="active" id="viewFull" onclick="setViewMode('full')">Full</button>
                        <button id="viewNails" onclick="setViewMode('nails')">Nails Only</button>
                    </div>
                </div>
            </div>

            <button class="btn btn-secondary btn-full" onclick="startOver()">Start Over</button>
        </div>

        <div class="credits">
            Â© 2026 Matt Donahue, William Turton, Ryan Scheuer, and Johnny Hamcheck
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-menu" id="debugMenu">
            <button onclick="debugFill1()">1 piece</button>
            <button onclick="debugFill2()">2 pieces</button>
            <button onclick="debugFill3()">3 pieces</button>
            <button onclick="debugFillCustom()">custom spacing</button>
            <button onclick="debugFillRandom()">random</button>
        </div>
        <button class="debug-toggle" onclick="toggleDebug()" title="Debug">?</button>
    </div>

    <script>
        let currentUnit = 'inches';
        let pieceCount = 1;
        let pieces = [];
        let spacingMode = 'even'; // 'even' or 'custom'
        let viewMode = 'full'; // 'full' or 'nails'
        const CM_PER_INCH = 2.54;

        function setSpacingMode(mode) {
            spacingMode = mode;
            document.getElementById('spacingEven').classList.toggle('active', mode === 'even');
            document.getElementById('spacingCustom').classList.toggle('active', mode === 'custom');
            document.getElementById('customSpacingInput').classList.toggle('visible', mode === 'custom');
        }

        function parseMixedNumber(str) {
            if (!str || str.trim() === '') return NaN;
            str = str.trim().toLowerCase();

            if (str.includes('ft') || str.includes("'")) {
                const ftMatch = str.match(/^([\d.]+)\s*(?:ft|')?\s*(?:([\d.]+)\s*(?:in|")?)?\s*$/);
                if (ftMatch) {
                    const feet = parseFloat(ftMatch[1]) || 0;
                    const inches = parseFloat(ftMatch[2]) || 0;
                    return feet * 12 + inches;
                }
            }

            const mixedMatch = str.match(/^(\d+)\s+(\d+)\/(\d+)$/);
            if (mixedMatch) {
                const whole = parseInt(mixedMatch[1]);
                const num = parseInt(mixedMatch[2]);
                const den = parseInt(mixedMatch[3]);
                return whole + (num / den);
            }

            const fracMatch = str.match(/^(\d+)\/(\d+)$/);
            if (fracMatch) {
                return parseInt(fracMatch[1]) / parseInt(fracMatch[2]);
            }

            return parseFloat(str);
        }

        function toMixedNumber(decimal) {
            if (isNaN(decimal)) return '--';

            const isNegative = decimal < 0;
            decimal = Math.abs(decimal);

            const whole = Math.floor(decimal);
            let remainder = decimal - whole;

            const sixteenths = Math.round(remainder * 16);

            if (sixteenths === 0) {
                return (isNegative ? '-' : '') + whole + '"';
            }
            if (sixteenths === 16) {
                return (isNegative ? '-' : '') + (whole + 1) + '"';
            }

            let num = sixteenths;
            let den = 16;

            while (num % 2 === 0 && den % 2 === 0) {
                num /= 2;
                den /= 2;
            }

            if (whole === 0) {
                return (isNegative ? '-' : '') + num + '/' + den + '"';
            }
            return (isNegative ? '-' : '') + whole + ' ' + num + '/' + den + '"';
        }

        function formatResult(inches) {
            if (currentUnit === 'cm') {
                return (inches * CM_PER_INCH).toFixed(1) + ' cm';
            }
            return toMixedNumber(inches);
        }

        function toInches(value) {
            return currentUnit === 'cm' ? value / CM_PER_INCH : value;
        }

        function setUnit(unit) {
            currentUnit = unit;
            document.getElementById('unitInches').classList.toggle('active', unit === 'inches');
            document.getElementById('unitCm').classList.toggle('active', unit === 'cm');

            const inchPlaceholder = unit === 'inches' ? 'e.g., 24 or 24 1/2' : 'e.g., 61';
            document.querySelectorAll('.dimension-input').forEach(input => {
                input.placeholder = inchPlaceholder;
            });
        }

        let pieceIdCounter = 0;

        function addPiece() {
            const container = document.getElementById('piecesContainer');
            const pieceId = pieceIdCounter++;
            const pieceCount = container.children.length + 1;

            const pieceDiv = document.createElement('div');
            pieceDiv.className = 'piece-card';
            pieceDiv.id = `piece-${pieceId}`;
            pieceDiv.innerHTML = `
                <div class="piece-header">
                    <h3>Piece ${pieceCount}</h3>
                    <button class="btn-remove" onclick="removePiece(${pieceId})">Remove</button>
                </div>
                <div class="input-row">
                    <div class="input-field">
                        <label>Width</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="width" placeholder="e.g., 24 or 24 1/2">
                    </div>
                    <div class="input-field">
                        <label>Height</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="height" placeholder="e.g., 36 or 36 1/4">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 12px;">
                    <div class="input-field">
                        <label>Hardware Span</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="span" placeholder="e.g., 16">
                        <p class="help-text">Distance between hanging points</p>
                    </div>
                    <div class="input-field">
                        <label>Hardware from Top</label>
                        <input type="text" class="dimension-input" data-piece="${pieceId}" data-field="fromTop" placeholder="e.g., 4">
                        <p class="help-text">Distance from top to hardware</p>
                    </div>
                </div>
            `;
            container.appendChild(pieceDiv);
            updatePieceNumbers();
        }

        function removePiece(pieceId) {
            const pieceDiv = document.getElementById(`piece-${pieceId}`);
            if (pieceDiv) {
                pieceDiv.remove();
                updatePieceNumbers();
                if (!document.getElementById('results').classList.contains('hidden')) {
                    calculate();
                }
            }
        }

        function updatePieceNumbers() {
            const container = document.getElementById('piecesContainer');
            const pieces = container.querySelectorAll('.piece-card');
            pieces.forEach((piece, index) => {
                const h3 = piece.querySelector('h3');
                if (h3) h3.textContent = `Piece ${index + 1}`;
            });
        }

        function calculate() {
            const container = document.getElementById('piecesContainer');
            const pieceCards = container.querySelectorAll('.piece-card');

            if (pieceCards.length === 0) {
                alert('Please add at least one piece');
                return;
            }

            const centerHeight = toInches(parseMixedNumber(document.getElementById('centerHeight').value)) || 60;
            const wallWidth = parseMixedNumber(document.getElementById('wallWidth').value);
            const wallHeight = parseMixedNumber(document.getElementById('wallHeight').value);

            pieces = [];

            let hasError = false;
            pieceCards.forEach((card, i) => {
                const pieceId = card.id.replace('piece-', '');
                const width = parseMixedNumber(card.querySelector(`[data-field="width"]`).value);
                const height = parseMixedNumber(card.querySelector(`[data-field="height"]`).value);
                const span = parseMixedNumber(card.querySelector(`[data-field="span"]`).value);
                const fromTop = parseMixedNumber(card.querySelector(`[data-field="fromTop"]`).value);

                if (isNaN(width) || isNaN(height) || isNaN(span) || isNaN(fromTop)) {
                    alert(`Please fill in all fields for Piece ${i + 1}`);
                    hasError = true;
                    return;
                }

                const widthIn = toInches(width);
                const heightIn = toInches(height);
                const spanIn = toInches(span);
                const fromTopIn = toInches(fromTop);

                const pictureTop = centerHeight + (heightIn / 2);
                const nailHeight = pictureTop - fromTopIn;

                pieces.push({
                    index: i + 1,
                    width: widthIn,
                    height: heightIn,
                    span: spanIn,
                    fromTop: fromTopIn,
                    nailHeight: nailHeight,
                    centerHeight: centerHeight
                });
            });

            if (hasError) return;

            renderResults();
            drawDiagram(wallWidth ? toInches(wallWidth) : null, wallHeight ? toInches(wallHeight) : null);

            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            pieces.forEach((piece, i) => {
                const html = `
                    <div class="piece-card">
                        <h3>Piece ${piece.index}</h3>
                        <div class="result-item">
                            <h3>Nail Height from Floor</h3>
                            <div class="result-value">${formatResult(piece.nailHeight)}</div>
                            <div class="note">Measure up from the floor</div>
                        </div>
                        <div class="input-row">
                            <div class="result-item" style="flex:1">
                                <h3>Distance Between Nails</h3>
                                <div class="result-value">${formatResult(piece.span)}</div>
                            </div>
                            <div class="result-item" style="flex:1">
                                <h3>Each Nail from Center</h3>
                                <div class="result-value">${formatResult(piece.span / 2)}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // Store nail hitboxes for hover detection
        let nailHitboxes = [];

        function drawDiagram(wallWidthIn, wallHeightIn) {
            const canvas = document.getElementById('diagramCanvas');
            const ctx = canvas.getContext('2d');
            nailHitboxes = [];

            const centerHeight = pieces.length > 0 ? pieces[0].centerHeight : 60;
            const totalPiecesWidth = pieces.reduce((sum, p) => sum + p.width, 0);

            // Calculate spacing based on mode
            let spacing = 0;
            let edgeSpacing = 0;
            let effectiveWallWidth;

            if (pieces.length > 1) {
                if (spacingMode === 'custom') {
                    const customSpacingValue = parseMixedNumber(document.getElementById('customSpacing').value);
                    spacing = isNaN(customSpacingValue) ? 12 : toInches(customSpacingValue);
                    // Total width of pieces plus spacing between them
                    const totalContentWidth = totalPiecesWidth + spacing * (pieces.length - 1);
                    effectiveWallWidth = wallWidthIn || Math.max(totalContentWidth + 40, 80);
                    // Center the group: edge spacing is (wall - content) / 2
                    edgeSpacing = (effectiveWallWidth - totalContentWidth) / 2;
                } else {
                    effectiveWallWidth = wallWidthIn || Math.max(totalPiecesWidth + 60, 120);
                    const availableSpace = effectiveWallWidth - totalPiecesWidth;
                    spacing = availableSpace / (pieces.length + 1);
                    edgeSpacing = spacing; // Edge spacing equals inter-piece spacing in even mode
                }
            } else {
                effectiveWallWidth = wallWidthIn || Math.max(totalPiecesWidth + 40, 80);
                edgeSpacing = (effectiveWallWidth - totalPiecesWidth) / 2;
            }

            // Find highest piece top
            let highestTop = 0;
            pieces.forEach(p => {
                const pieceTop = p.centerHeight + p.height / 2;
                if (pieceTop > highestTop) highestTop = pieceTop;
            });

            // Diagram height is just above highest piece (add 10% padding for labels)
            const effectiveWallHeight = highestTop * 1.10;

            // Set canvas size based on exact wall proportions
            const containerWidth = canvas.parentElement.offsetWidth || 600;
            const aspectRatio = effectiveWallHeight / effectiveWallWidth;
            const canvasWidth = containerWidth;
            const canvasHeight = canvasWidth * aspectRatio;

            // Set actual canvas resolution (2x for retina)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvasWidth * dpr;
            canvas.height = canvasHeight * dpr;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            ctx.scale(dpr, dpr);

            // Clear canvas - exact wall representation
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Scale: 1 inch = X pixels (wall fills canvas exactly)
            const drawScale = canvasWidth / effectiveWallWidth;

            // Floor line (thick, at bottom - this IS the wall edge)
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, canvasHeight);
            ctx.lineTo(canvasWidth, canvasHeight);
            ctx.stroke();

            // Wall edges (left and right)
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, canvasHeight);
            ctx.moveTo(canvasWidth, 0);
            ctx.lineTo(canvasWidth, canvasHeight);
            ctx.stroke();

            // Floor label
            ctx.fillStyle = '#000';
            ctx.font = 'bold 11px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('FLOOR', canvasWidth / 2, canvasHeight - 6);

            // Calculate starting X position (edgeSpacing centers content on wall)
            let currentX = edgeSpacing * drawScale;

            // Draw center height reference line (dotted)
            const centerHeightY = canvasHeight - (centerHeight * drawScale);
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 5]);
            ctx.beginPath();
            ctx.moveTo(0, centerHeightY);
            ctx.lineTo(canvasWidth, centerHeightY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Center height label
            ctx.fillStyle = '#666';
            ctx.font = '9px monospace';
            ctx.textAlign = 'right';
            ctx.fillText(formatResult(centerHeight) + ' center', canvasWidth - 5, centerHeightY - 3);

            // Draw pieces
            pieces.forEach((piece, i) => {
                const picWidth = piece.width * drawScale;
                const picHeight = piece.height * drawScale;
                const picBottom = canvasHeight - ((piece.centerHeight - piece.height / 2) * drawScale);
                const picTop = picBottom - picHeight;
                const picCenterX = currentX + picWidth / 2;

                // Nail positions (calculated for both modes)
                const nailY = canvasHeight - (piece.nailHeight * drawScale);
                const nailOffset = (piece.span / 2) * drawScale;
                const nail1X = picCenterX - nailOffset;
                const nail2X = picCenterX + nailOffset;
                const circleRadius = 8;
                const xSize = 4;

                if (viewMode === 'full') {
                    // Frame
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(currentX, picTop, picWidth, picHeight);

                    // Dotted center line on each piece
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([4, 4]);
                    ctx.beginPath();
                    ctx.moveTo(picCenterX, picTop);
                    ctx.lineTo(picCenterX, picBottom);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Piece number
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 14px monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(piece.index.toString(), picCenterX, picTop + picHeight / 2);
                }

                // Dotted line connecting nails
                ctx.strokeStyle = '#f00';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(nail1X + circleRadius, nailY);
                ctx.lineTo(nail2X - circleRadius, nailY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Span label between nails (shown by default now)
                const spanLabelX = (nail1X + nail2X) / 2;
                ctx.fillStyle = '#000';
                ctx.fillRect(spanLabelX - 22, nailY - 18, 44, 12);
                ctx.fillStyle = '#0f0';
                ctx.font = 'bold 9px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(formatResult(piece.span), spanLabelX, nailY - 12);

                // Left nail - red circle with X
                ctx.strokeStyle = '#f00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(nail1X, nailY, circleRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(nail1X - xSize, nailY - xSize);
                ctx.lineTo(nail1X + xSize, nailY + xSize);
                ctx.moveTo(nail1X + xSize, nailY - xSize);
                ctx.lineTo(nail1X - xSize, nailY + xSize);
                ctx.stroke();

                // Right nail - red circle with X
                ctx.beginPath();
                ctx.arc(nail2X, nailY, circleRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(nail2X - xSize, nailY - xSize);
                ctx.lineTo(nail2X + xSize, nailY + xSize);
                ctx.moveTo(nail2X + xSize, nailY - xSize);
                ctx.lineTo(nail2X - xSize, nailY + xSize);
                ctx.stroke();

                // Store hitbox for hover (the line between nails)
                nailHitboxes.push({
                    x1: nail1X,
                    x2: nail2X,
                    y: nailY,
                    span: piece.span
                });

                // Nail height label (left side)
                ctx.fillStyle = '#000';
                ctx.fillRect(2, nailY - 7, 50, 14);
                ctx.fillStyle = '#0f0';
                ctx.font = 'bold 10px monospace';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(formatResult(piece.nailHeight), 5, nailY);

                // In nails-only mode, show distance from left wall to first nail
                if (viewMode === 'nails') {
                    const distFromLeft = nail1X;
                    // Distance from wall corner to first nail
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(2, nailY + 20);
                    ctx.lineTo(nail1X, nailY + 20);
                    ctx.stroke();
                    // Label
                    ctx.fillStyle = '#000';
                    ctx.fillRect(distFromLeft / 2 - 22, nailY + 25, 44, 12);
                    ctx.fillStyle = '#888';
                    ctx.font = '8px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(formatResult(nail1X / drawScale), distFromLeft / 2, nailY + 31);
                }

                // Store positions for spacing indicators
                piece.rightEdgeX = currentX + picWidth;
                piece.leftEdgeX = currentX;
                piece.picTop = picTop;
                piece.picBottom = picBottom;
                piece.nail1X = nail1X;
                piece.nail2X = nail2X;
                piece.nailY = nailY;

                currentX += picWidth + spacing * drawScale;
            });

            if (viewMode === 'full') {
                // Draw edge spacing for even mode
                if (pieces.length >= 1 && spacingMode === 'even') {
                    const firstPiece = pieces[0];
                    const lastPiece = pieces[pieces.length - 1];
                    const midY = (firstPiece.picTop + firstPiece.picBottom) / 2;

                    // Left edge spacing
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(2, midY);
                    ctx.lineTo(firstPiece.leftEdgeX - 2, midY);
                    ctx.stroke();

                    // Left edge label
                    ctx.fillStyle = '#000';
                    ctx.fillRect(firstPiece.leftEdgeX / 2 - 22, midY - 20, 44, 14);
                    ctx.fillStyle = '#0f0';
                    ctx.font = 'bold 9px monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(formatResult(edgeSpacing), firstPiece.leftEdgeX / 2, midY - 13);

                    // Right edge spacing
                    ctx.strokeStyle = '#000';
                    ctx.beginPath();
                    ctx.moveTo(lastPiece.rightEdgeX + 2, midY);
                    ctx.lineTo(canvasWidth - 2, midY);
                    ctx.stroke();

                    // Right edge label - "repeat"
                    const rightEdgeMid = lastPiece.rightEdgeX + (canvasWidth - lastPiece.rightEdgeX) / 2;
                    ctx.fillStyle = '#000';
                    ctx.fillRect(rightEdgeMid - 25, midY - 20, 50, 14);
                    ctx.fillStyle = '#888';
                    ctx.font = '8px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('(repeat)', rightEdgeMid, midY - 13);
                }

                // Draw spacing indicators between paintings
                if (pieces.length > 1) {
                    for (let i = 0; i < pieces.length - 1; i++) {
                        const leftPiece = pieces[i];
                        const rightPiece = pieces[i + 1];

                        const gapStart = leftPiece.rightEdgeX + 2;
                        const gapEnd = rightPiece.leftEdgeX - 2;
                        const gapCenterX = (gapStart + gapEnd) / 2;

                        const avgTop = (leftPiece.picTop + rightPiece.picTop) / 2;
                        const avgBottom = (leftPiece.picBottom + rightPiece.picBottom) / 2;
                        const lineY = avgTop + (avgBottom - avgTop) / 2;

                        // Spacing line
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(gapStart, lineY);
                        ctx.lineTo(gapEnd, lineY);
                        ctx.stroke();

                        // Spacing label
                        ctx.fillStyle = '#000';
                        ctx.fillRect(gapCenterX - 22, lineY - 20, 44, 14);
                        ctx.fillStyle = '#0f0';
                        ctx.font = 'bold 9px monospace';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(formatResult(spacing), gapCenterX, lineY - 13);
                    }
                }
            }

            // Nails-only mode: show distances between nail groups
            if (viewMode === 'nails' && pieces.length > 1) {
                for (let i = 0; i < pieces.length - 1; i++) {
                    const leftPiece = pieces[i];
                    const rightPiece = pieces[i + 1];
                    const avgNailY = (leftPiece.nailY + rightPiece.nailY) / 2;

                    // Distance from right nail of left piece to left nail of right piece
                    const gapStart = leftPiece.nail2X;
                    const gapEnd = rightPiece.nail1X;
                    const gapCenterX = (gapStart + gapEnd) / 2;
                    const gapDistance = (gapEnd - gapStart) / drawScale;

                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(gapStart + 10, avgNailY + 25);
                    ctx.lineTo(gapEnd - 10, avgNailY + 25);
                    ctx.stroke();

                    ctx.fillStyle = '#000';
                    ctx.fillRect(gapCenterX - 25, avgNailY + 30, 50, 12);
                    ctx.fillStyle = '#888';
                    ctx.font = '8px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(formatResult(gapDistance), gapCenterX, avgNailY + 36);
                }
            }

            // Wall center line (dotted vertical)
            const wallCenterX = canvasWidth / 2;
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(wallCenterX, 0);
            ctx.lineTo(wallCenterX, canvasHeight - 15);
            ctx.stroke();
            ctx.setLineDash([]);

            // Wall center label at top
            ctx.fillStyle = '#000';
            ctx.fillRect(wallCenterX - 22, 2, 44, 12);
            ctx.fillStyle = '#fff';
            ctx.font = '9px monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('CENTER', wallCenterX, 8);

            // Setup hover listener
            setupCanvasHover();
        }

        function setupCanvasHover() {
            const canvas = document.getElementById('diagramCanvas');
            const tooltip = document.getElementById('canvasTooltip');

            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                let found = false;
                for (const box of nailHitboxes) {
                    // Check if mouse is near the line between nails
                    if (x >= box.x1 - 5 && x <= box.x2 + 5 && Math.abs(y - box.y) < 15) {
                        tooltip.textContent = 'Span: ' + formatResult(box.span);
                        tooltip.style.left = (x + 10) + 'px';
                        tooltip.style.top = (y - 25) + 'px';
                        tooltip.style.display = 'block';
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    tooltip.style.display = 'none';
                }
            };

            canvas.onmouseleave = function() {
                tooltip.style.display = 'none';
            };
        }

        function saveDiagram() {
            const canvas = document.getElementById('diagramCanvas');
            const link = document.createElement('a');
            link.download = 'hangar-diagram.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function copyDiagram() {
            const canvas = document.getElementById('diagramCanvas');
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                alert('Diagram copied to clipboard!');
            } catch (err) {
                alert('Could not copy to clipboard. Try using Save instead.');
            }
        }

        function startOver() {
            pieces = [];
            pieceIdCounter = 0;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('piecesContainer').innerHTML = '';
            addPiece();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', function() {
            addPiece();
        });

        function toggleColorMode() {
            document.body.classList.toggle('light-mode');
            const btn = document.getElementById('colorToggle');
            if (document.body.classList.contains('light-mode')) {
                btn.textContent = 'dark mode';
            } else {
                btn.textContent = 'light mode';
            }
        }

        // Debug functions
        function toggleDebug() {
            document.getElementById('debugMenu').classList.toggle('open');
        }

        function fillPieceValues(pieceCard, width, height, span, fromTop) {
            pieceCard.querySelector('[data-field="width"]').value = width;
            pieceCard.querySelector('[data-field="height"]').value = height;
            pieceCard.querySelector('[data-field="span"]').value = span;
            pieceCard.querySelector('[data-field="fromTop"]').value = fromTop;
        }

        function debugFill1() {
            startOver();
            document.getElementById('wallWidth').value = '120';
            const pieceCards = document.querySelectorAll('.piece-card');
            fillPieceValues(pieceCards[0], '24', '36', '16', '4');
            document.getElementById('debugMenu').classList.remove('open');
            calculate();
        }

        function debugFill2() {
            startOver();
            document.getElementById('wallWidth').value = '144';
            const pieceCards = document.querySelectorAll('.piece-card');
            fillPieceValues(pieceCards[0], '24', '30', '14', '3');
            addPiece();
            setTimeout(() => {
                const cards = document.querySelectorAll('.piece-card');
                fillPieceValues(cards[1], '30', '40', '18', '5');
                document.getElementById('debugMenu').classList.remove('open');
                calculate();
            }, 50);
        }

        function debugFill3() {
            startOver();
            document.getElementById('wallWidth').value = '180';
            const pieceCards = document.querySelectorAll('.piece-card');
            fillPieceValues(pieceCards[0], '20', '24', '12', '3');
            addPiece();
            addPiece();
            setTimeout(() => {
                const cards = document.querySelectorAll('.piece-card');
                fillPieceValues(cards[1], '24', '36', '16', '4');
                fillPieceValues(cards[2], '18', '24', '10', '2 1/2');
                document.getElementById('debugMenu').classList.remove('open');
                calculate();
            }, 50);
        }

        function debugFillCustom() {
            startOver();
            setSpacingMode('custom');
            document.getElementById('customSpacing').value = '8';
            document.getElementById('wallWidth').value = '96';
            const pieceCards = document.querySelectorAll('.piece-card');
            fillPieceValues(pieceCards[0], '16', '20', '10', '2');
            addPiece();
            setTimeout(() => {
                const cards = document.querySelectorAll('.piece-card');
                fillPieceValues(cards[1], '16', '20', '10', '2');
                document.getElementById('debugMenu').classList.remove('open');
                calculate();
            }, 50);
        }

        function debugFillRandom() {
            startOver();
            // Random wall width between 72" (6ft) and 240" (20ft)
            const wallWidth = Math.floor(Math.random() * 168) + 72;
            document.getElementById('wallWidth').value = wallWidth;
            document.getElementById('centerHeight').value = '60'; // Keep 60" center

            // Random number of pieces (1-4)
            const numPieces = Math.floor(Math.random() * 4) + 1;

            function fillRandomPiece(card) {
                const width = Math.floor(Math.random() * 30) + 12; // 12-42"
                const height = Math.floor(Math.random() * 40) + 16; // 16-56"
                const span = Math.floor(Math.random() * (width - 8)) + 6; // 6 to width-2
                const fromTop = Math.floor(Math.random() * 6) + 2; // 2-8"
                fillPieceValues(card, width, height, span, fromTop);
            }

            const firstCard = document.querySelectorAll('.piece-card')[0];
            fillRandomPiece(firstCard);

            if (numPieces > 1) {
                for (let i = 1; i < numPieces; i++) {
                    addPiece();
                }
                setTimeout(() => {
                    const cards = document.querySelectorAll('.piece-card');
                    for (let i = 1; i < cards.length; i++) {
                        fillRandomPiece(cards[i]);
                    }
                    document.getElementById('debugMenu').classList.remove('open');
                    calculate();
                }, 50);
            } else {
                document.getElementById('debugMenu').classList.remove('open');
                calculate();
            }
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('viewFull').classList.toggle('active', mode === 'full');
            document.getElementById('viewNails').classList.toggle('active', mode === 'nails');
            // Redraw if we have results
            if (!document.getElementById('results').classList.contains('hidden')) {
                const wallWidth = parseMixedNumber(document.getElementById('wallWidth').value);
                const wallHeight = parseMixedNumber(document.getElementById('wallHeight').value);
                drawDiagram(wallWidth ? toInches(wallWidth) : null, wallHeight ? toInches(wallHeight) : null);
            }
        }
    </script>
</body>
</html>
